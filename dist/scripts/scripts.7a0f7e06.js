"use strict";var app=angular.module("lodBook",["ngSanitize","ngRoute","ngAnimate","duScroll","mgcrea.ngStrap","ui.bootstrap","angular-parallax","picardy.fontawesome","lodBook.text","lodBook.people","lodBook.resources","lodBook.places","lodBook.events","lodBook.organisations","lodBook.filters"]);app.config(["$routeProvider","$locationProvider",function(a,b){a.otherwise({redirectTo:"/text/1"}),b.hashPrefix("!")}]),app.factory("DataFactory",["$document","$filter",function(a,b){var c=function(a){var b=[];return angular.forEach(a,function(a){var c={};angular.forEach(a,function(a,b){c[b.replace(":","_")]=a}),b.push(c)}),b};console.log("Running DataFactory...");var d=[],e={},f=angular.element("#data-json")[0];return d=JSON.parse(f.innerHTML)["@graph"],d=c(d),console.log(d),e.getItem=function(a){var c=b("filter")(d,{"@id":a});return console.log(c[0]),c[0]},e.getSubjectOf=function(a){var c=b("searchJSONLD")(d,{about:a});return c},e.getMentionsOf=function(a){var c=b("searchJSONLD")(d,{mentions:a});return c},e.getRelation=function(a,c){var e={};e[c]=a;var f=b("searchJSONLD")(d,e);return f},e.getCreatorOf=function(a){var c=b("searchJSONLD")(d,{creator:a});return c},e.getPeople=function(){var a=b("filter")(d,{"@id":"/people/"});return a},e.getOrganisations=function(){var a=b("filter")(d,{"@id":"/organisations/"});return a},e.getResources=function(){var a=b("filter")(d,{"@id":"/resources/"});return a},e.getPlaces=function(){var a=b("filter")(d,{"@id":"/places/"});return a},e.getImages=function(a){var c=b("filter")(d,{"@type":"CreativeWork",about:a,thumbnailUrl:""});return c},e.loading="Loading data from DataFactory...",e}]),app.factory("TextFactory",["$document","$filter",function(a,b){console.log("Running TextFactory...");var c,d,e={},f=[],g={},h={},i={},j="Another great LOD Book",k=1,l=1,m=0,n=0;angular.forEach(angular.element('[property="name"]',angular.element("#content")),function(a){var b=angular.element(a).text(),c=angular.element(a).attr("about");g[b]=c,c in h?h[c].push(b):h[c]=[b]});var o=angular.element("#content").children();return angular.forEach(o,function(a){var b=a.tagName;if(b.match(/H1/))j=angular.element(a).text(),angular.forEach([": "," â€“ "],function(a){var b=j.split(a);2===b.length&&(j=b[0],c=a,d=b[1])});else if(b.match(/H[2-6]{1}/)){var e=m,h=parseInt(b.substring(1),10);0!==m&&h<i[m].level&&(e=i[i[m].parent].parent),i[l]={parent:e,content:angular.element(a).html(),level:h,start:k},m=l,f.push({id:l,parent:m,type:"h",level:h,content:angular.element(a).html()}),l++}else{var o=angular.element(a).text(),p=0,q=[];o.length>0&&(p=o.match(/\s+/g).length),angular.forEach(g,function(b,c){var d=new RegExp(c);null!==d.exec(angular.element(a).text())&&q.push({label:c,link:b})}),f.push({id:k,parent:m,type:"p",content:angular.element(a).html(),links:q,words:p,wordsProgress:n}),n+=p,k++}}),o.remove(),e.getTitle=function(){return[j,c,d]},e.getText=function(){return f},e.getHeadings=function(){return i},e.getWords=function(){return n},e.getParas=function(){return b("filter")(f,{type:"p"})},e.getPara=function(a){return b("filter")(f,{type:"p",id:a})[0]},e.getLinks=function(a){return b("filter")(f,{type:"p",id:a})[0].links},e.getParaCount=function(){return b("filter")(f,{type:"p"}).length},e.getParaNumbers=function(){for(var a=[],b=e.getParaCount(),c=1;b>=c;c++)a.push(c);return a},e.getReferencesTo=function(a){h=[];var c=b("filter")(f,{type:"p",links:a});console.log(c),angular.forEach(c,function(c){var d=b("filter")(c.links,{link:a});console.log(d)})},e.loading="Loading data from TextFactory...",e}]),app.run(["TextFactory",function(a){console.log(a.loading)}]),app.run(["DataFactory",function(a){console.log(a.loading)}]),app.controller("AppCtrl",["$scope","$location","TextFactory",function(a,b,c){a.title=c.getTitle(),a.isActive=function(a){var c=new RegExp(a),d=c.exec(b.path());return d},a.checkClass=function(a){var b;return-1!==a.indexOf("/people/")?b="people":-1!==a.indexOf("/organisations/")?b="people":-1!==a.indexOf("/resources/")?b="resource":-1!==a.indexOf("/events/")?b="event":-1!==a.indexOf("/places/")&&(b="place"),b}}]);var filters=angular.module("lodBook.filters",[]);filters.filter("localiseUrl",function(){return function(a){var b=a.match(/(#\!\/(resources|people|places|events|organisations)\/[a-z_\-0-9]+)/);return b?b[1]:a}}),filters.filter("dateFormat",["$filter",function(a){return function(b){var c,d=b.split("-");return c=1===d.length?b:2===d.length?a("date")(b+"-01","MMMM yyyy"):a("date")(b,"d MMMM yyyy")}}]),filters.filter("labelIdentifier",function(){return function(a){var b=a;return-1!==a.indexOf("wikipedia")?b="Wikipedia":(-1!==a.indexOf("nla.party")||-1!==a.indexOf("trove.nla"))&&(b="Trove"),b}}),filters.filter("listLength",function(){return function(a){var b=!1;return a&&Array.isArray(a)===!0?b=a.length:a&&(b=Object.keys(a).length),b}}),filters.filter("listify",function(){return function(a){return a&&Array.isArray(a)===!1&&(a=[a]),a}}),filters.filter("nonEmpty",function(){return function(a){return!!(a&&Object.keys(a).length>0)}}),filters.filter("searchJSONLD",function(){return function(a,b){var c=[],d=Object.keys(b)[0],e=b[d];return angular.forEach(a,function(a){a.hasOwnProperty(d)&&-1!==a[d]["@id"].indexOf(e)&&c.push(a)}),c}});var app=angular.module("lodBook.text",["ngRoute","duScroll","debounce","ngAnimate","ui.bootstrap","ui.utils"]);app.config(["$routeProvider","$anchorScrollProvider",function(a){a.when("/text",{redirectTo:"/text/1"}),a.when("/text/:paraId",{templateUrl:"modules/text/views/read_para.html",controller:"ReadParaCtrl"})}]),app.controller("ReadCtrl",["$rootScope","$scope",function(a,b){b.headings=a.headings,b.text=a.text}]),app.controller("ReadParaCtrl",["$scope","$document","$routeParams","$location","$timeout","TextFactory","DataFactory",function(a,b,c,d,e,f,g){a.paraId=parseInt(c.paraId,10),a.currentParas=[],a.activePara="",a.activeParaId="",a.currentLinks=[],a.wordsTotal=f.getWords(),a.text=f.getText(),a.gotoPara=function(){d.path("/text/"+a.gotoParaId)},a.scrollToPara=function(){var c=angular.element(document.getElementById("para-"+a.paraId));b.scrollToElement(c,60)},a.setActiveParaId=function(b){a.activeParaId=b,a.activePara=f.getPara(b),a.getCurrentLinks()},a.getCurrentLinks=function(){var b=[],c=[],d=f.getPara(a.activeParaId);angular.forEach(d.links,function(a){var d=g.getItem(a.link);"undefined"!=typeof d&&("Person"===d["@type"]&&-1===b.indexOf(d)?b.push(d):"CreativeWork"===d["@type"]&&c.push(d))}),a.currentLinks={people:b,resources:c}},e(function(){a.paraId>1&&a.scrollToPara(),a.setActiveParaId(a.paraId)})}]),app.directive("makeHeading",function(){return{restrict:"E",scope:{heading:"="},template:'<a href="#!/read/p/{{ heading.start }}"><h1 ng-if="heading.level==1">{{ heading.content }}</h1><h2 ng-if="heading.level==2">{{ heading.content }}</h2><h3 ng-if="heading.level==3">{{ heading.content }}</h3></a>'}}),app.directive("scroll",["$parse","$document","$window","debounce",function(a,b,c,d){function e(a,e){var f=function(){var b=[],d=e.children(),f=e[0].offsetTop-40,g=angular.element(c).scrollTop(),h=g+angular.element(c).innerHeight();angular.forEach(d,function(a){var c=a.children[0];if("P"===c.tagName){var d=c.offsetTop+f;if(d>=g&&h>=d){var e=parseInt(c.id.match(/para-(\d+)/)[1],10);b.push(e)}}});var i=Math.min.apply(Math,b);a.$apply(function(){a.scroll({paraId:i})})};angular.element(b).on("scroll",d(f,500))}return{restrict:"A",scope:{scroll:"&",scrollItem:"="},link:e}}]);var app=angular.module("lodBook.people",["ngRoute"]);app.config(["$routeProvider",function(a){a.when("/people",{templateUrl:"modules/people/views/people.html",controller:"PeopleCtrl"}),a.when("/people/:personId",{templateUrl:"modules/people/views/person.html",controller:"PersonCtrl"})}]),app.controller("PeopleCtrl",["$scope","DataFactory",function(a,b){a.people=b.getPeople()}]),app.controller("PersonCtrl",["$scope","$routeParams","DataFactory","TextFactory",function(a,b,c){var d="people/"+b.personId,e=c.getItem(d);a.person=e,a.subjectOf=c.getRelation(d,"about"),a.mentionsOf=c.getRelation(d,"mentions"),a.creatorOf=c.getRelation(d,"creator"),a.knows=c.getRelation(d,"knows"),a.spouses=c.getRelation(d,"spouse"),a.children=c.getRelation(d,"parent"),a.parents=c.getRelation(d,"children"),a.siblings=c.getRelation(d,"sibling"),a.relatedTo=c.getRelation(d,"relatedTo"),a.memberOf=c.getRelation(d,"member"),a.employeeOf=c.getRelation(d,"employee"),console.log(a.person),a.birthPlace=function(){var a=null;return e.birthPlace&&(a=c.getItem(e.birthPlace["@id"])),a},a.deathPlace=function(){var a=null;return e.deathPlace&&(a=c.getItem(e.deathPlace["@id"])),a}}]);var app=angular.module("lodBook.resources",["ngRoute"]);app.config(["$routeProvider",function(a){a.when("/resources",{templateUrl:"modules/resources/views/resources.html",controller:"ResourcesCtrl"}),a.when("/resources/:resourceId",{templateUrl:"modules/resources/views/resource.html",controller:"ResourceCtrl"})}]),app.controller("ResourcesCtrl",["$scope","$filter","DataFactory",function(a,b,c){var d=c.getResources();console.log(d),a.resources=b("orderBy")(d,"schema_name")}]),app.controller("ResourceCtrl",["$scope","$routeParams","$filter","DataFactory",function(a,b,c,d){var e="/resources/"+b.resourceId,f=d.getItem(e);a.resource=f,a.subjects=d.getRelation(e,"subjectOf"),a.mentions=d.getRelation(e,"mentionedBy"),a.publisher=d.getRelation(e,"publishes"),a.provider=d.getRelation(e,"provides"),a.hasParts=d.getRelation(e,"isPartOf"),a.isPartOf=d.getRelation(e,"hasPart")}]);var app=angular.module("lodBook.places",["ngRoute","leaflet-directive"]);app.config(["$routeProvider",function(a){a.when("/places",{redirectTo:"/places/list"}),a.when("/places/map",{templateUrl:"modules/places/views/places_map.html",controller:"PlacesMapCtrl"}),a.when("/places/list",{templateUrl:"modules/places/views/places_list.html",controller:"PlacesListCtrl"}),a.when("/places/:placeId",{templateUrl:"modules/places/views/place.html",controller:"PlaceCtrl"})}]),app.controller("PlacesMapCtrl",["$scope","$filter","DataFactory",function(a,b,c){var d={},e=c.getPlaces(),f=b("searchJSONLD")(e,{geo:"_"});angular.forEach(f,function(a){var e=c.getItem(a.geo["@id"]),f='<a href="'+b("localiseUrl")(a["@id"])+'">'+a.name+"</a>";d[a["@id"]]={lat:e.latitude,lng:e.longitude,message:f}}),a.markers=d}]),app.controller("PlacesListCtrl",["$scope","$filter","DataFactory",function(a,b,c){var d=c.getPlaces();a.places=b("orderBy")(d,"name")}]),app.controller("PlaceCtrl",["$scope","$routeParams","$filter","DataFactory",function(a,b,c,d){var e="/places/"+b.placeId,f=d.getItem(e);if(a.place=f,f.geo){var g=d.getItem(f.geo["@id"]);a.geo=g,a.markers={},a.centre={lat:g.latitude,lng:g.longitude,zoom:8},a.markers.main={lat:g.latitude,lng:g.longitude}}a.containedIn=d.getRelation(e,"contains"),a.contains=d.getRelation(e,"containedIn"),a.born=d.getRelation(e,"birthPlace"),a.died=d.getRelation(e,"deathPlace"),a.located=d.getRelation(e,"location")}]);var app=angular.module("lodBook.events",["ngRoute","angular-timeline"]);app.config(["$routeProvider",function(a){a.when("/events",{templateUrl:"modules/events/views/events.html",controller:"EventsCtrl"}),a.when("/events/timeline",{templateUrl:"modules/events/views/events_timeline.html",controller:"EventsCtrl"}),a.when("/events/:eventId",{templateUrl:"modules/events/views/organisation.html",controller:"EventCtrl"})}]),app.controller("EventsCtrl",["$scope","$filter","DataFactory",function(a,b,c){var d=[],e=c.getPeople(),f=b("filter")(e,{birthDate:"1"}),g=b("filter")(e,{deathDate:"1"});angular.forEach(f,function(a){var b={"@id":a["@id"],"@type":"Birth",name:"Birth of "+a.name,startDate:a.birthDate};"undefined"!=typeof a.image&&(b.image=a.image),d.push(b)}),angular.forEach(g,function(a){var b={"@id":a["@id"],"@type":"Death",name:"Death of "+a.name,startDate:a.deathDate};"undefined"!=typeof a.image&&(b.image=a.image),d.push(b)}),a.events=b("orderBy")(d,"startDate"),console.log(d)}]),app.controller("EventCtrl",["$scope","$routeParams","DataFactory","TextFactory",function(a,b,c){var d="events/"+b.eventId;a.event=c.getItem(d),a.subjectOf=c.getSubjectOf(d),a.mentionsOf=c.getMentionsOf(d),a.creatorOf=c.getCreatorOf(d)}]),app.filter("timeline",function(){return function(a){var b="left";return"Death"===a&&(b="right"),b}});var app=angular.module("lodBook.organisations",["ngRoute"]);app.config(["$routeProvider",function(a){a.when("/organisations",{templateUrl:"modules/organisations/views/organisations.html",controller:"OrganisationsCtrl"}),a.when("/organisations/:orgId",{templateUrl:"modules/organisations/views/organisation.html",controller:"OrganisationCtrl"})}]),app.controller("OrganisationsCtrl",["$scope","DataFactory",function(a,b){a.orgs=b.getOrganisations()}]),app.controller("OrganisationCtrl",["$scope","$routeParams","DataFactory","TextFactory",function(a,b,c){var d="organisations/"+b.orgId,e=c.getItem(d);a.organisation=e,a.provides=c.getRelation(d,"provider"),a.publishes=c.getRelation(d,"publisher"),a.partOf=c.getRelation(d,"subOrganization"),a.hasParts=c.getRelation(d,"subOrganizationOf"),a.members=c.getRelation(d,"memberOf"),a.employees=c.getRelation(d,"worksFor"),a.subjectOf=c.getRelation(d,"about"),a.mentions=c.getRelation(d,"mentions"),a.location=function(){var a=null;return e.location&&(a=c.getItem(e.location["@id"])),a}}]);